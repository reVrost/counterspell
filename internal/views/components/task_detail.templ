package components

import (
	"strings"
	"fmt"
	"github.com/revrost/code/counterspell/internal/views"
	"github.com/revrost/code/counterspell/internal/utils"
)

// toolIcon returns an appropriate FA icon for a tool name
func toolIcon(name string) string {
	switch {
	case strings.Contains(name, "edit"), strings.Contains(name, "write"):
		return "fa-pen"
	case strings.Contains(name, "read"), strings.Contains(name, "view"):
		return "fa-eye"
	case strings.Contains(name, "bash"), strings.Contains(name, "exec"):
		return "fa-terminal"
	case strings.Contains(name, "search"), strings.Contains(name, "grep"), strings.Contains(name, "glob"):
		return "fa-search"
	case strings.Contains(name, "list"), strings.Contains(name, "ls"):
		return "fa-folder-open"
	default:
		return "fa-cog"
	}
}

// truncateResult limits tool result length for display
func truncateResult(s string) string {
	if len(s) > 2000 {
		return s[:2000] + "\n... (truncated)"
	}
	return s
}

// hasTextContent checks if a message has any non-empty text content
func hasTextContent(msg views.UIMessage) bool {
	for _, c := range msg.Content {
		if c.Type == "text" && c.Text != "" {
			return true
		}
	}
	return false
}

templ LogEntry(log views.UILogEntry) {
	<div class="ml-4 relative">
		<div
			class={ "absolute -left-[21px] top-1 h-2.5 w-2.5 rounded-full border border-[#0D1117]",
			templ.KV("bg-red-500", log.Type == "error"),
			templ.KV("bg-green-500", log.Type == "success"),
			templ.KV("bg-yellow-500", log.Type == "plan"),
			templ.KV("bg-purple-500", log.Type == "code"),
			templ.KV("bg-blue-500", log.Type == "info") }
		></div>
		<div class="flex justify-between items-start">
			<span
				class={ "text-sm font-bold block mb-0.5",
				templ.KV("text-red-400", log.Type == "error"),
				templ.KV("text-green-400", log.Type == "success"),
				templ.KV("text-yellow-400", log.Type == "plan"),
				templ.KV("text-purple-400", log.Type == "code"),
				templ.KV("text-blue-400", log.Type == "info"),
				templ.KV("text-gray-300", log.Type != "error" && log.Type != "success" && log.Type != "plan" && log.Type != "code" && log.Type != "info") }
			>{ log.Type }</span>
			<span class="text-[10px] text-gray-600 font-mono">{ log.Timestamp.Format("15:04:05") }</span>
		</div>
		<p class={ "text-sm", templ.KV("text-red-300", log.Type == "error"), templ.KV("text-gray-400", log.Type != "error") }>{ log.Message }</p>
	</div>
}

// MessageBubble renders a single message in the conversation
templ MessageBubble(msg views.UIMessage) {
	if msg.Role == "user" && hasTextContent(msg) {
		<!-- User message (only if has text) -->
		<div class="px-4 py-2 border-b border-gray-800/50">
			<div class="flex gap-2">
				<div class="w-4 h-4 rounded-full bg-blue-500/20 border border-blue-500/30 flex items-center justify-center shrink-0">
					<i class="fas fa-user text-[7px] text-blue-400"></i>
				</div>
				<div class="flex-1 min-w-0 -mt-px">
					for _, content := range msg.Content {
						if content.Type == "text" && content.Text != "" {
							<div class="text-sm text-gray-200 whitespace-pre-wrap leading-normal">{ content.Text }</div>
						}
					}
				</div>
			</div>
		</div>
	} else if msg.Role == "assistant" {
		<!-- Assistant message -->
		<div class="px-4 py-2 bg-[#0D1117] border-b border-gray-800/50">
			<div class="flex gap-2">
				<div class="w-4 h-4 rounded-full bg-purple-500/20 border border-purple-500/30 flex items-center justify-center shrink-0">
					<i class="fas fa-robot text-[7px] text-purple-400"></i>
				</div>
				<div class="flex-1 min-w-0 space-y-1 -mt-px">
					for _, content := range msg.Content {
						if content.Type == "text" && content.Text != "" {
							<div class="text-sm text-gray-300 leading-normal prose prose-invert prose-sm prose-p:my-1 prose-headings:font-bold prose-headings:text-sm prose-code:text-xs prose-pre:text-xs max-w-none">
								@templ.Raw(utils.RenderMarkdownHTML(content.Text))
							</div>
						} else if content.Type == "tool_use" {
							@ToolCallBlock(content)
						} else if content.Type == "tool_result" {
							@ToolResultBlock(content)
						}
					}
				</div>
			</div>
		</div>
	}
}

// ToolCallBlock renders a tool call in a sleek collapsible style (like Claude Code)
templ ToolCallBlock(content views.UIContent) {
	<div class="my-1" x-data="{ expanded: false }">
		<button
			@click="expanded = !expanded"
			class="flex items-center gap-1.5 text-xs text-gray-500 hover:text-gray-300 transition group"
		>
			<div class="w-4 h-4 rounded bg-gray-800 border border-gray-700 flex items-center justify-center group-hover:border-gray-600 transition">
				<i class={ fmt.Sprintf("fas %s text-xs text-gray-500 group-hover:text-gray-400", toolIcon(content.ToolName)) }></i>
			</div>
			<span class="font-mono">{ content.ToolName }</span>
			<i class="fas fa-chevron-right text-xs transition-transform" :class="expanded ? 'rotate-90' : ''"></i>
		</button>
		<div x-show="expanded" x-collapse class="mt-1 ml-5">
			<pre class="text-xs text-gray-500 bg-gray-900/50 rounded p-1.5 overflow-x-auto border border-gray-800">{ content.ToolInput }</pre>
		</div>
	</div>
}

// ToolResultBlock renders a tool result
templ ToolResultBlock(content views.UIContent) {
	if content.Text != "" {
		<div class="my-1 ml-5" x-data="{ expanded: false }">
			<button
				@click="expanded = !expanded"
				class="flex items-center gap-1.5 text-[10px] text-gray-600 hover:text-gray-400 transition"
			>
				<i class="fas fa-check-circle text-green-600 text-[8px]"></i>
				<span class="font-mono">result</span>
				<i class="fas fa-chevron-right text-[7px] transition-transform" :class="expanded ? 'rotate-90' : ''"></i>
			</button>
			<div x-show="expanded" x-collapse class="mt-1">
				<pre class="text-[9px] text-gray-500 bg-gray-900/50 rounded p-1.5 overflow-x-auto border border-gray-800 max-h-32 overflow-y-auto">{ truncateResult(content.Text) }</pre>
			</div>
		</div>
	}
}

templ TaskDetail(task *views.UITask, project views.UIProject) {
	<div class="flex flex-col h-full" x-data="{ showChat: false, activeTab: 'agent' }">
		<!-- Modal Header -->
		<div class="px-4 py-2 border-b border-white/5 flex items-center justify-between shrink-0 bg-[#16191F]">
			<div class="flex items-center gap-3">
				<button @click="closeModal()" class="w-8 h-8 rounded-full hover:bg-white/5 flex items-center justify-center text-gray-400">
					<i class="fas fa-arrow-left"></i>
				</button>
				<div>
					<div class="flex items-center gap-2">
						<span class={ fmt.Sprintf("%s text-[10px]", project.Color) }>
							<i class={ fmt.Sprintf("fas %s", project.Icon) }></i> { project.Name }
						</span>
						<span class="text-[10px] text-gray-600 font-mono">{ fmt.Sprintf("#%s", task.ID) }</span>
					</div>
					<h2 class="text-sm font-bold text-gray-200 line-clamp-1 w-48">{ task.Description }</h2>
				</div>
			</div>
			<!-- Trash Action -->
			<button
				hx-post={ fmt.Sprintf("/action/discard/%s", task.ID) }
				hx-swap="none"
				class="text-gray-600 hover:text-red-400 transition"
				onclick="if(!confirm('Discard task?')) return false;"
			>
				<i class="fas fa-trash"></i>
			</button>
		</div>
		<!-- Tabs Container -->
		<div class="flex items-center justify-between p-2 bg-[#16191F] shrink-0 border-b border-white/5">
			<div class="w-6"></div>
			<div class="flex bg-gray-900 rounded-lg p-0.5 border border-gray-700/50">
				<button
					@click="activeTab = 'agent'"
					:class="activeTab === 'agent' ? 'bg-gray-800 text-white shadow' : 'text-gray-500'"
					class="px-4 py-1 text-[11px] font-medium rounded-md transition-all"
				>Agent</button>
				<button
					@click="activeTab = 'diff'"
					:class="activeTab === 'diff' ? 'bg-gray-800 text-white shadow' : 'text-gray-500'"
					class="px-4 py-1 text-[11px] font-medium rounded-md transition-all"
				>Diff</button>
				<button
					@click="activeTab = 'activity'"
					:class="activeTab === 'activity' ? 'bg-gray-800 text-white shadow' : 'text-gray-500'"
					class="px-4 py-1 text-[11px] font-medium rounded-md transition-all"
				>Log</button>
			</div>
			<!-- Status Indicator -->
			<div class="w-6 flex justify-end pr-2">
				if task.Status == "in_progress" {
					<div class="w-1.5 h-1.5 rounded-full bg-orange-400" title="In Progress"></div>
				} else if task.Status == "review" {
					<div class="w-1.5 h-1.5 rounded-full bg-[#b197fc]" title="Needs Review"></div>
				}
			</div>
		</div>
		<!-- Unified SSE Connection (always active - handles status changes including chat continuations) -->
		<div
			hx-ext="sse"
			sse-connect={ fmt.Sprintf("/task/%s/stream", task.ID) }
			class="hidden"
			id="task-sse-connection"
		>
			<!-- Hidden elements that receive SSE updates and swap into visible targets -->
			<div sse-swap="agent" hx-target="#agent-content" hx-swap="innerHTML"></div>
			<div sse-swap="diff" hx-target="#diff-content" hx-swap="innerHTML"></div>
			<div sse-swap="log" hx-target="#log-content" hx-swap="beforeend"></div>
			<div sse-swap="complete"></div>
		</div>
		<!-- Main Content Area -->
		<div
			class="flex-1 overflow-y-auto bg-[#0D1117] relative w-full"
			id="content-scroll"
			x-init="
				$nextTick(() => $el.scrollTop = $el.scrollHeight);
				new MutationObserver(() => $el.scrollTop = $el.scrollHeight).observe($el, {childList: true, subtree: true});
			"
			x-effect="activeTab; $nextTick(() => $el.scrollTop = $el.scrollHeight)"
		>
			<!-- Tab 1: AGENT CONVERSATION -->
			<div x-show="activeTab === 'agent'" class="pb-32">
				<div id="agent-content">
					if task.Status == "in_progress" {
						if len(task.Messages) > 0 {
							<div class="space-y-0">
								for _, msg := range task.Messages {
									@MessageBubble(msg)
								}
							</div>
						}
						<div class="flex items-center gap-3 px-4 py-3">
							<div class="relative">
								<div class="w-8 h-8 rounded-lg bg-violet-500/10 border border-violet-500/20 flex items-center justify-center">
									<i class="fas fa-robot text-sm text-violet-400 pulse-glow"></i>
								</div>
								<div class="absolute inset-0 animate-spin" style="animation-duration: 3s;">
									<div class="absolute -top-0.5 left-1/2 -translate-x-1/2 w-1 h-1 bg-violet-400 rounded-full"></div>
								</div>
							</div>
							<div>
								<p class="text-sm font-medium shimmer">Agent is thinking...</p>
								<p class="text-[10px] text-gray-600">Analyzing code</p>
							</div>
						</div>
					} else if len(task.Messages) > 0 {
						<div class="space-y-0">
							for _, msg := range task.Messages {
								@MessageBubble(msg)
							}
						</div>
					} else if task.AgentOutput != "" {
						<div class="p-5">
							<div class="text-sm text-gray-300 leading-normal prose prose-invert prose-sm prose-p:my-1 prose-headings:font-bold prose-headings:text-sm prose-code:text-xs prose-pre:text-xs max-w-none">
								@templ.Raw(utils.RenderMarkdownHTML(task.AgentOutput))
							</div>
						</div>
					} else {
						<div class="p-5 text-gray-500 italic text-sm">No agent output</div>
					}
				</div>
			</div>
			<!-- Tab 2: DIFF -->
			<div x-show="activeTab === 'diff'" class="p-0 min-h-full pb-32">
				<div class="px-4 py-3 border-b border-gray-800 sticky top-0 bg-[#0D1117] z-10 flex justify-between">
					<span class="text-sm text-gray-400 font-mono">changes</span>
					<span class="text-[10px] text-green-500 font-mono">git diff</span>
				</div>
				<div id="diff-content" class="p-4 font-mono text-sm leading-6 text-gray-300 whitespace-pre-wrap break-all">
					if task.Status == "in_progress" {
						<div class="flex flex-col items-center justify-center h-48 text-gray-500 space-y-4">
							<i class="fas fa-cog fa-spin text-3xl opacity-50"></i>
							<p class="text-sm font-mono">Generating changes...</p>
						</div>
					} else if task.GitDiff != "" {
						for _, line := range strings.Split(task.GitDiff, "\n") {
							if strings.HasPrefix(line, "+") {
								<div class="diff-add">{ line }</div>
							} else if strings.HasPrefix(line, "-") {
								<div class="diff-del">{ line }</div>
							} else {
								<div>{ line }</div>
							}
						}
					} else {
						<div class="text-gray-500 italic">No changes made</div>
					}
				</div>
			</div>
			<!-- Tab 3: ACTIVITY -->
			<div x-show="activeTab === 'activity'" class="p-5 pb-32 space-y-6">
				<div id="log-content" class="relative border-l border-gray-800 ml-2 space-y-6">
					if len(task.Logs) == 0 {
						<div class="ml-4 text-sm text-gray-500 italic" id="no-activity-msg">No activity yet</div>
					}
					for _, log := range task.Logs {
						@LogEntry(log)
					}
				</div>
			</div>
		</div>
		<!-- Bottom Actions Toolbar (Sticky) -->
		<div class="shrink-0 p-4 border-t border-white/5 bg-[#16191F] pb-8">
			<!-- Chat Input Mode (Capsule Style) -->
			<div x-show="showChat" x-transition.origin.bottom class="absolute bottom-0 inset-x-0 p-4 bg-gradient-to-t from-[#16191F] via-[#16191F] to-transparent z-20 pb-8 flex justify-center">
				<form
					hx-post={ fmt.Sprintf("/action/chat/%s", task.ID) }
					hx-swap="none"
					@htmx:after-request="showChat = false; text = ''"
					class="bg-[#1C1F26] border border-gray-700/50 rounded-[32px] p-1.5 pl-4 flex items-end shadow-2xl relative backdrop-blur-md transition-all duration-200 w-full max-w-2xl"
					x-data="{
						text: '',
						showFileMenu: false,
						files: ['main.go', 'go.mod', 'README.md', 'Dockerfile', 'pkg/server.go', 'pkg/utils.go', 'ui/app.js'],
						resize() {
							this.$refs.input.style.height = 'auto';
							let newHeight = this.$refs.input.scrollHeight;
							if(newHeight > window.innerHeight * 0.4) newHeight = window.innerHeight * 0.4;
							this.$refs.input.style.height = newHeight + 'px';
						},
						checkMention(e) {
							if (this.text.match(/@[^ ]*$/)) {
								this.showFileMenu = true;
							} else {
								this.showFileMenu = false;
							}
							if (e.key === 'Escape') this.showFileMenu = false;
						},
						insertFile(f) {
							this.text = this.text.replace(/@[^ ]*$/, '') + f + ' ';
							this.showFileMenu = false;
							this.$nextTick(() => { this.$refs.input.focus(); });
						}
					}"
				>
					<!-- Cancel (X) -->
					<button type="button" @click="showChat = false" class="text-gray-500 hover:text-white transition p-2 mb-0.5">
						<i class="fas fa-times text-lg"></i>
					</button>
					<!-- Attachment -->
					<button type="button" class="text-gray-400 hover:text-white transition p-2 mb-0.5">
						<i class="fas fa-paperclip text-lg"></i>
					</button>
					<!-- Expanding Textarea -->
					<div class="flex-1 mx-2 relative min-w-0">
						<!-- File Menu Popover -->
						<div
							x-show="showFileMenu"
							x-cloak
							x-transition.opacity.duration.100ms
							class="absolute bottom-full left-0 mb-2 w-48 bg-[#16191F] border border-gray-700 rounded-xl shadow-2xl overflow-hidden max-h-40 overflow-y-auto z-50"
						>
							<div class="px-3 py-2 text-[10px] text-gray-500 font-bold uppercase tracking-wider border-b border-gray-800">Files</div>
							<template x-for="file in files">
								<div @click="insertFile(file)" class="px-3 py-2 hover:bg-white/10 text-sm text-gray-300 font-mono cursor-pointer transition">
									<span class="text-purple-400 opacity-60 mr-1">#</span> <span x-text="file"></span>
								</div>
							</template>
						</div>
						<textarea
							name="message"
							x-model="text"
							x-ref="input"
							@input="resize()"
							@keyup="checkMention($event)"
							@keydown.enter.prevent="if (!$event.shiftKey) $el.form.requestSubmit()"
							rows="1"
							placeholder="Refine code instructions..."
							class="bg-transparent border-none focus:ring-0 focus:outline-none text-white text-base placeholder-gray-500 w-full resize-none font-medium p-0 leading-6 max-h-[40vh] py-1"
						></textarea>
					</div>
					<!-- Model Selector (Visual) -->
					<button type="button" class="text-gray-400 hover:text-white transition p-2 mr-1 mb-0.5">
						<i class="fas fa-bolt text-lg"></i>
					</button>
					<!-- Submit Button -->
					<button
						type="submit"
						class="bg-white text-black hover:bg-gray-200 w-10 h-10 rounded-full flex items-center justify-center shrink-0 mb-0.5 shadow-lg transition-transform active:scale-95 relative z-10"
					>
						<i class="fas fa-arrow-up text-sm"></i>
					</button>
				</form>
			</div>
			<!-- Default Buttons -->
			<div x-show="!showChat" class="grid grid-cols-4 gap-2 h-12">
				<!-- Retry Button -->
				<button
					hx-post={ fmt.Sprintf("/action/retry/%s", task.ID) }
					hx-swap="none"
					class="col-span-1 bg-[#21262d] hover:bg-[#30363d] border border-gray-700/50 rounded-lg flex items-center justify-center gap-px active:scale-95 transition-all text-gray-400 hover:text-white"
				>
					<i class="fas fa-undo text-[10px]"></i>
					<span class="text-[10px] font-semibold uppercase tracking-wide">Retry</span>
				</button>
				<!-- Chat Button -->
				<button
					@click="showChat = true"
					class="col-span-1 bg-[#21262d] hover:bg-[#30363d] border border-gray-700/50 rounded-lg flex items-center justify-center gap-px active:scale-95 transition-all text-gray-400 hover:text-white"
				>
					<i class="fas fa-comment-dots text-[10px]"></i>
					<span class="text-[10px] font-semibold uppercase tracking-wide">Chat</span>
				</button>
				<!-- PR Button -->
				<button
					hx-post={ fmt.Sprintf("/action/pr/%s", task.ID) }
					hx-swap="none"
					hx-disabled-elt="this"
					class="col-span-1 bg-[#21262d] hover:bg-[#30363d] border border-gray-700/50 rounded-lg flex items-center justify-center gap-px active:scale-95 transition-all text-gray-400 hover:text-white disabled:opacity-50 disabled:cursor-not-allowed [&.htmx-request]:pointer-events-none"
				>
					<i class="fab fa-github text-[10px] [.htmx-request>&]:hidden"></i>
					<i class="fas fa-spinner fa-spin text-[10px] hidden [.htmx-request>&]:inline"></i>
					<span class="text-[10px] font-semibold uppercase tracking-wide [.htmx-request>&]:hidden">PR</span>
				</button>
				<!-- Merge to Main Button -->
				<button
					hx-post={ fmt.Sprintf("/action/merge/%s", task.ID) }
					hx-swap="none"
					hx-disabled-elt="this"
					class="col-span-1 bg-white hover:bg-gray-100 text-black rounded-lg flex items-center justify-center gap-px active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed [&.htmx-request]:pointer-events-none"
				>
					<i class="fas fa-code-merge text-[10px] [.htmx-request>&]:hidden"></i>
					<i class="fas fa-spinner fa-spin text-[10px] hidden [.htmx-request>&]:inline"></i>
					<span class="text-[10px] font-semibold uppercase tracking-wide [.htmx-request>&]:hidden">main</span>
				</button>
			</div>
		</div>
	</div>
}
