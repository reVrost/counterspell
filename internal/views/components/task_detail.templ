package components

import (
	"strings"
	"fmt"
	"github.com/revrost/code/counterspell/internal/views"
	"github.com/revrost/code/counterspell/internal/utils"
)

// toolIcon returns an appropriate FA icon for a tool name
func toolIcon(name string) string {
	switch {
	case strings.Contains(name, "edit"), strings.Contains(name, "write"):
		return "fa-pen"
	case strings.Contains(name, "read"), strings.Contains(name, "view"):
		return "fa-eye"
	case strings.Contains(name, "bash"), strings.Contains(name, "exec"):
		return "fa-terminal"
	case strings.Contains(name, "search"), strings.Contains(name, "grep"), strings.Contains(name, "glob"):
		return "fa-search"
	case strings.Contains(name, "list"), strings.Contains(name, "ls"):
		return "fa-folder-open"
	default:
		return "fa-cog"
	}
}

// truncateResult limits tool result length for display
func truncateResult(s string) string {
	if len(s) > 2000 {
		return s[:2000] + "\n... (truncated)"
	}
	return s
}

// hasTextContent checks if a message has any non-empty text content
func hasTextContent(msg views.UIMessage) bool {
	for _, c := range msg.Content {
		if c.Type == "text" && c.Text != "" {
			return true
		}
	}
	return false
}

// taskDetailXData generates the Alpine.js x-data for the task detail component
// Inline definition to avoid scope issues with nested x-data
func taskDetailXData(task *views.UITask) string {
	agentRunning := "false"
	if task.Status == "in_progress" {
		agentRunning = "true"
	}
	chatURL := fmt.Sprintf("/action/chat/%s", task.ID)
	return fmt.Sprintf(`{
		showChat: false,
		showTodos: false,
		todos: [],
		activeTab: "agent",
		messageQueue: [],
		agentRunning: %s,
		sendingMessage: false,
		lastEventId: 0,
		confirmAction: null,
		activeModelId: localStorage.getItem("counterspell_model") || "%s",
		models: %s,
		chatUrl: "%s",
		
		// Chat form state (merged to avoid nested x-data scope issues)
		chatText: "",
		chatFocused: false,
		showFileMenu: false,
		modelOpen: false,
		chatFiles: ["main.go", "go.mod", "README.md", "Dockerfile", "pkg/server.go", "pkg/utils.go", "ui/app.js"],
		
		get completedCount() { return this.todos.filter(t => t.status === "completed").length },
		get inProgressTask() { 
			const t = this.todos.find(t => t.status === "in_progress");
			return t ? (t.active_form || t.content) : "";
		},
		get modelName() {
			const m = this.models.find(m => m.id === this.activeModelId);
			return m ? m.name.split(" ")[1] : this.activeModelId.split("#")[1];
		},
		
		setModel(id) {
			this.activeModelId = id;
			localStorage.setItem("counterspell_model", id);
		},
		
		resizeChatInput() {
			const el = this.$refs.chatInput;
			if (!el) return;
			el.style.height = "auto";
			let newHeight = el.scrollHeight;
			if (newHeight > window.innerHeight * 0.35) newHeight = window.innerHeight * 0.35;
			el.style.height = newHeight + "px";
		},
		checkMention(e) {
			if (this.chatText.match(/@[^ ]*$/)) {
				this.showFileMenu = true;
			} else {
				this.showFileMenu = false;
			}
			if (e.key === "Escape") this.showFileMenu = false;
		},
		insertFile(f) {
			this.chatText = this.chatText.replace(/@[^ ]*$/, "") + f + " ";
			this.showFileMenu = false;
			this.$nextTick(() => { if (this.$refs.chatInput) this.$refs.chatInput.focus(); });
		},
		
		submitChat() {
			if (!this.chatText.trim()) return;
			const msgText = this.chatText.trim();
			if (this.agentRunning) {
				this.queueMessage(msgText);
				this.chatText = "";
			} else {
				this.sendMessage(msgText);
				this.chatText = "";
				this.showChat = false;
			}
		},
		
		handleAgentEvent(eventId) {
			if (eventId && eventId > this.lastEventId) {
				this.lastEventId = eventId;
			}
			this.sendingMessage = false;
		},
		handleTodoEvent(data) {
			try { this.todos = JSON.parse(data); } catch(err) { console.error("Todo parse error:", err); }
		},
		handleCompleteEvent() {
			this.agentRunning = false;
			this.sendingMessage = false;
			this.$nextTick(() => this.processQueue());
		},
		
		queueMessage(msg) {
			this.messageQueue = [...this.messageQueue, msg];
		},
		async processQueue() {
			if (this.messageQueue.length === 0) return;
			const [msg, ...rest] = this.messageQueue;
			this.messageQueue = rest;
			await this.sendMessage(msg);
		},
		
		async sendMessage(msg) {
			if (!msg.trim()) return;
			this.sendingMessage = true;
			this.agentRunning = true;
			const formData = new FormData();
			formData.append("message", msg.trim());
			formData.append("model_id", this.activeModelId);
			try {
				await fetch(this.chatUrl, { method: "POST", body: formData });
			} catch (err) {
				console.error("Failed to send message:", err);
				this.sendingMessage = false;
				this.agentRunning = false;
			}
		}
	}`, agentRunning, uiModels[0].ID, getModelsJSON(), chatURL)
}

templ LogEntry(log views.UILogEntry) {
	<div class="ml-4 relative">
		<div
			class={ "absolute -left-[21px] top-1 h-2.5 w-2.5 rounded-full border border-[#0D1117]",
			templ.KV("bg-red-500", log.Type == "error"),
			templ.KV("bg-green-500", log.Type == "success"),
			templ.KV("bg-yellow-500", log.Type == "plan"),
			templ.KV("bg-purple-500", log.Type == "code"),
			templ.KV("bg-blue-500", log.Type == "info") }
		></div>
		<div class="flex justify-between items-start">
			<span
				class={ "text-xs font-bold block mb-0.5",
				templ.KV("text-red-400", log.Type == "error"),
				templ.KV("text-green-400", log.Type == "success"),
				templ.KV("text-yellow-400", log.Type == "plan"),
				templ.KV("text-purple-400", log.Type == "code"),
				templ.KV("text-blue-400", log.Type == "info"),
				templ.KV("text-gray-300", log.Type != "error" && log.Type != "success" && log.Type != "plan" && log.Type != "code" && log.Type != "info") }
			>{ log.Type }</span>
			<span class="text-[10px] text-gray-600 font-mono">{ log.Timestamp.Format("15:04:05") }</span>
		</div>
		<p class={ "text-xs", templ.KV("text-red-300", log.Type == "error"), templ.KV("text-gray-400", log.Type != "error") }>{ log.Message }</p>
	</div>
}

// MessageBubble renders a single message in the conversation
templ MessageBubble(msg views.UIMessage) {
	if msg.Role == "user" && hasTextContent(msg) {
		<!-- User message (only if has text) -->
		<div class="px-4 py-2 border-b border-gray-800/50">
			<div class="flex gap-2">
				<div class="w-4 h-4 rounded-full bg-blue-500/20 border border-blue-500/30 flex items-center justify-center shrink-0">
					<i class="fas fa-user text-[7px] text-blue-400"></i>
				</div>
				<div class="flex-1 min-w-0 -mt-px">
					for _, content := range msg.Content {
						if content.Type == "text" && content.Text != "" {
							<div class="text-sm text-gray-200 whitespace-pre-wrap leading-normal">{ content.Text }</div>
						}
					}
				</div>
			</div>
		</div>
	} else if msg.Role == "assistant" {
		<!-- Assistant message -->
		<div class="px-4 py-2 bg-[#0D1117] border-b border-gray-800/50">
			<div class="flex gap-2">
				<div class="w-4 h-4 rounded-full bg-purple-500/20 border border-purple-500/30 flex items-center justify-center shrink-0">
					<i class="fas fa-robot text-[7px] text-purple-400"></i>
				</div>
				<div class="flex-1 min-w-0 space-y-1 -mt-px">
					for _, content := range msg.Content {
						if content.Type == "text" && content.Text != "" {
							<div class="text-sm text-gray-300 leading-normal prose prose-invert prose-sm prose-p:my-3 prose-headings:font-bold prose-headings:text-sm prose-headings:mt-4 prose-headings:mb-2 prose-code:text-xs prose-pre:text-xs prose-pre:my-3 prose-ul:my-2 prose-ol:my-2 prose-li:my-1 max-w-none">
								@templ.Raw(utils.RenderMarkdownHTML(content.Text))
							</div>
						} else if content.Type == "tool_use" {
							@ToolCallBlock(content)
						} else if content.Type == "tool_result" {
							@ToolResultBlock(content)
						}
					}
				</div>
			</div>
		</div>
	}
}

// ToolCallBlock renders a tool call in a sleek collapsible style (like Claude Code)
templ ToolCallBlock(content views.UIContent) {
	<div class="my-1" x-data="{ expanded: false }">
		<button
			@click="expanded = !expanded"
			class="flex items-center gap-1.5 text-xs text-gray-500 hover:text-gray-300 transition group"
		>
			<div class="w-4 h-4 rounded bg-gray-800 border border-gray-700 flex items-center justify-center group-hover:border-gray-600 transition">
				<i class={ fmt.Sprintf("fas %s text-xs text-gray-500 group-hover:text-gray-400", toolIcon(content.ToolName)) }></i>
			</div>
			<span class="font-mono">{ content.ToolName }</span>
			<i class="fas fa-chevron-right text-xs transition-transform" :class="expanded ? 'rotate-90' : ''"></i>
		</button>
		<div x-show="expanded" x-collapse class="mt-1 ml-5">
			<pre class="text-xs text-gray-500 bg-gray-900/50 rounded p-1.5 overflow-x-auto border border-gray-800">{ content.ToolInput }</pre>
		</div>
	</div>
}

// ToolResultBlock renders a tool result
templ ToolResultBlock(content views.UIContent) {
	if content.Text != "" {
		<div class="my-1 ml-5" x-data="{ expanded: false }">
			<button
				@click="expanded = !expanded"
				class="flex items-center gap-1.5 text-[10px] text-gray-600 hover:text-gray-400 transition"
			>
				<i class="fas fa-check-circle text-green-600 text-[8px]"></i>
				<span class="font-mono">result</span>
				<i class="fas fa-chevron-right text-[7px] transition-transform" :class="expanded ? 'rotate-90' : ''"></i>
			</button>
			<div x-show="expanded" x-collapse class="mt-1">
				<pre class="text-[9px] text-gray-500 bg-gray-900/50 rounded p-1.5 overflow-x-auto border border-gray-800 max-h-32 overflow-y-auto">{ truncateResult(content.Text) }</pre>
			</div>
		</div>
	}
}

templ TaskDetail(task *views.UITask, project views.UIProject) {
	<div class="flex flex-col h-full" x-data={ taskDetailXData(task) } @close-chat.window="showChat = false">
		<!-- Modal Header -->
		<div class="px-4 py-2 border-b border-white/5 flex items-center justify-between shrink-0 bg-[#16191F]">
			<div class="flex items-center gap-3">
				<button @click="closeModal()" class="w-8 h-8 rounded-full hover:bg-white/5 flex items-center justify-center text-gray-400">
					<i class="fas fa-arrow-left"></i>
				</button>
				<div>
					<div class="flex items-center gap-2">
						<span class={ fmt.Sprintf("%s text-[10px]", project.Color) }>
							<i class={ fmt.Sprintf("fas %s", project.Icon) }></i> { project.Name }
						</span>
						<span class="text-[10px] text-gray-600 font-mono">{ fmt.Sprintf("#%s", task.ID) }</span>
					</div>
					<h2 class="text-sm font-bold text-gray-200 line-clamp-1 w-48">{ task.Description }</h2>
				</div>
			</div>
			<!-- Trash Action -->
			<button
				hx-post={ fmt.Sprintf("/action/discard/%s", task.ID) }
				hx-swap="none"
				class="text-gray-600 hover:text-red-400 transition"
				onclick="if(!confirm('Discard task?')) return false;"
			>
				<i class="fas fa-trash"></i>
			</button>
		</div>
		<!-- Tabs Container -->
		<div class="flex items-center justify-between p-2 bg-[#16191F] shrink-0 border-b border-white/5">
			<div class="w-6"></div>
			<div class="flex bg-gray-900 rounded-lg p-0.5 border border-gray-700/50">
				<button
					@click="activeTab = 'agent'"
					:class="activeTab === 'agent' ? 'bg-gray-800 text-white shadow' : 'text-gray-500'"
					class="px-4 py-1 text-[11px] font-medium rounded-md transition-all"
				>Agent</button>
				<button
					@click="activeTab = 'diff'"
					:class="activeTab === 'diff' ? 'bg-gray-800 text-white shadow' : 'text-gray-500'"
					class="px-4 py-1 text-[11px] font-medium rounded-md transition-all"
				>Diff</button>
				<button
					@click="activeTab = 'activity'"
					:class="activeTab === 'activity' ? 'bg-gray-800 text-white shadow' : 'text-gray-500'"
					class="px-4 py-1 text-[11px] font-medium rounded-md transition-all"
				>Log</button>
			</div>
			<!-- Status Indicator -->
			<div class="w-6 flex justify-end pr-2">
				if task.Status == "in_progress" {
					<div class="w-1.5 h-1.5 rounded-full bg-orange-400" title="In Progress"></div>
				} else if task.Status == "review" {
					<div class="w-1.5 h-1.5 rounded-full bg-blue-400" title="Needs Review"></div>
				}
			</div>
		</div>
		<!-- Unified SSE Connection (always active - handles status changes including chat continuations) -->
		<!-- Event IDs are tracked for deduplication on reconnection -->
		<div
			hx-ext="sse"
			sse-connect={ fmt.Sprintf("/task/%s/stream", task.ID) }
			class="hidden"
			id="task-sse-connection"
			@htmx:sse-message.camel="
				const eventId = $event.detail.lastEventId ? parseInt($event.detail.lastEventId) : 0;
				if ($event.detail.type === 'agent') handleAgentEvent(eventId);
				else if ($event.detail.type === 'todo') handleTodoEvent($event.detail.data);
				else if ($event.detail.type === 'complete') handleCompleteEvent();
			"
		>
			<!-- Hidden elements that receive SSE updates and swap into visible targets -->
			<div sse-swap="agent" hx-target="#agent-content" hx-swap="innerHTML"></div>
			<div sse-swap="diff" hx-target="#diff-content" hx-swap="innerHTML"></div>
			<div sse-swap="log" hx-target="#log-content" hx-swap="beforeend"></div>
			<div sse-swap="complete" hx-swap="none"></div>
			<div sse-swap="todo" hx-swap="none"></div>
		</div>
		<!-- Floating Todo Indicator (only shows when todos exist) -->
		<div 
			x-show="todos.length > 0" 
			x-cloak
			x-transition:enter="transition ease-out duration-200"
			x-transition:enter-start="opacity-0 translate-y-2"
			x-transition:enter-end="opacity-100 translate-y-0"
			class="fixed bottom-24 right-4 z-30"
		>
			<button
				@click="showTodos = true"
				class="group flex items-center gap-2 h-9 pl-3 pr-4 bg-[#161B22] hover:bg-[#1C2128] border border-white/[0.08] hover:border-purple-500/30 rounded-full shadow-xl shadow-black/40 transition-all"
			>
				<!-- Progress circle -->
				<div class="relative w-5 h-5">
					<svg class="w-5 h-5 -rotate-90" viewBox="0 0 20 20">
						<circle cx="10" cy="10" r="8" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-700"/>
						<circle 
							cx="10" cy="10" r="8" fill="none" stroke="currentColor" stroke-width="2" 
							class="text-green-500 transition-all duration-300"
							:stroke-dasharray="`${(completedCount / todos.length) * 50.26} 50.26`"
						/>
					</svg>
					<span class="absolute inset-0 flex items-center justify-center text-[8px] font-bold text-white" x-text="completedCount + '/' + todos.length"></span>
				</div>
				<!-- Current task (truncated) -->
				<span 
					x-show="inProgressTask" 
					class="text-[11px] text-gray-400 group-hover:text-gray-300 max-w-[120px] truncate transition-colors"
					x-text="inProgressTask"
				></span>
				<span 
					x-show="!inProgressTask && completedCount < todos.length" 
					class="text-[11px] text-gray-500"
				>Tasks</span>
				<span 
					x-show="completedCount === todos.length" 
					class="text-[11px] text-green-400"
				>Done!</span>
			</button>
		</div>
		<!-- Todo Modal -->
		<template x-teleport="body">
			<div
				x-show="showTodos"
				x-transition:enter="transition ease-out duration-200"
				x-transition:enter-start="opacity-0"
				x-transition:enter-end="opacity-100"
				x-transition:leave="transition ease-in duration-150"
				x-transition:leave-start="opacity-100"
				x-transition:leave-end="opacity-0"
				class="fixed inset-0 z-[200] flex items-start justify-center pt-[15vh] bg-black/60 backdrop-blur-sm"
				@click.self="showTodos = false"
				@keydown.escape.window="showTodos = false"
			>
				<div
					x-show="showTodos"
					x-transition:enter="transition ease-out duration-200"
					x-transition:enter-start="opacity-0 scale-95 translate-y-4"
					x-transition:enter-end="opacity-100 scale-100 translate-y-0"
					x-transition:leave="transition ease-in duration-150"
					x-transition:leave-start="opacity-100 scale-100 translate-y-0"
					x-transition:leave-end="opacity-0 scale-95 translate-y-4"
					class="bg-[#161B22] border border-white/[0.08] rounded-2xl w-[380px] max-h-[60vh] shadow-2xl shadow-black/50 overflow-hidden flex flex-col"
				>
					<!-- Modal Header -->
					<div class="px-4 py-3 border-b border-white/[0.06] flex items-center justify-between shrink-0">
						<div class="flex items-center gap-2">
							<div class="w-6 h-6 rounded-lg bg-purple-500/10 flex items-center justify-center">
								<i class="fas fa-list-check text-xs text-purple-400"></i>
							</div>
							<h3 class="text-sm font-semibold text-white">Agent Tasks</h3>
						</div>
						<div class="flex items-center gap-2">
							<span class="text-[10px] text-gray-500 font-mono" x-text="completedCount + ' / ' + todos.length + ' done'"></span>
							<button @click="showTodos = false" class="w-6 h-6 rounded-lg hover:bg-white/[0.06] flex items-center justify-center text-gray-500 hover:text-gray-300 transition-colors">
								<i class="fas fa-xmark text-xs"></i>
							</button>
						</div>
					</div>
					<!-- Progress Bar -->
					<div class="h-0.5 bg-gray-800">
						<div 
							class="h-full bg-gradient-to-r from-purple-500 to-green-500 transition-all duration-300"
							:style="`width: ${todos.length ? (completedCount / todos.length) * 100 : 0}%`"
						></div>
					</div>
					<!-- Task List -->
					<div class="flex-1 overflow-y-auto p-2 space-y-1">
						<template x-for="(todo, index) in todos" :key="index">
							<div 
								class="flex items-start gap-3 px-3 py-2 rounded-xl transition-colors"
								:class="{
									'bg-green-500/5': todo.status === 'completed',
									'bg-purple-500/10 border border-purple-500/20': todo.status === 'in_progress',
									'hover:bg-white/[0.02]': todo.status === 'pending'
								}"
							>
								<!-- Status Icon -->
								<div class="w-5 h-5 shrink-0 flex items-center justify-center mt-0.5">
									<template x-if="todo.status === 'completed'">
										<div class="w-4 h-4 rounded-full bg-green-500/20 flex items-center justify-center">
											<i class="fas fa-check text-[8px] text-green-400"></i>
										</div>
									</template>
									<template x-if="todo.status === 'in_progress'">
										<div class="w-4 h-4 rounded-full bg-purple-500/20 flex items-center justify-center relative">
											<div class="w-1.5 h-1.5 rounded-full bg-purple-400 animate-pulse"></div>
											<div class="absolute inset-0 rounded-full border border-purple-400/50 animate-ping" style="animation-duration: 2s;"></div>
										</div>
									</template>
									<template x-if="todo.status === 'pending'">
										<div class="w-4 h-4 rounded-full border border-gray-600"></div>
									</template>
								</div>
								<!-- Content -->
								<div class="flex-1 min-w-0">
									<p 
										class="text-sm leading-tight"
										:class="{
											'text-gray-400 line-through': todo.status === 'completed',
											'text-white': todo.status === 'in_progress',
											'text-gray-300': todo.status === 'pending'
										}"
										x-text="todo.status === 'in_progress' ? (todo.active_form || todo.content) : todo.content"
									></p>
								</div>
							</div>
						</template>
						<!-- Empty State -->
						<div x-show="todos.length === 0" class="py-8 text-center">
							<div class="w-12 h-12 rounded-full bg-gray-800 flex items-center justify-center mx-auto mb-3">
								<i class="fas fa-clipboard-list text-gray-600 text-lg"></i>
							</div>
							<p class="text-sm text-gray-500">No tasks yet</p>
							<p class="text-xs text-gray-600 mt-1">The agent will create tasks as needed</p>
						</div>
					</div>
				</div>
			</div>
		</template>
		<!-- Main Content Area -->
		<div
			class="flex-1 overflow-y-auto bg-[#0D1117] relative w-full"
			id="content-scroll"
			x-init="
				$nextTick(() => $el.scrollTop = $el.scrollHeight);
				new MutationObserver(() => $el.scrollTop = $el.scrollHeight).observe($el, {childList: true, subtree: true});
			"
			x-effect="activeTab; $nextTick(() => $el.scrollTop = $el.scrollHeight)"
		>
			<!-- Tab 1: AGENT CONVERSATION -->
			<div x-show="activeTab === 'agent'" class="pb-32">
				<div id="agent-content" class="mt-1">
					if task.Status == "in_progress" {
						if len(task.Messages) > 0 {
							<div class="space-y-0">
								for _, msg := range task.Messages {
									@MessageBubble(msg)
								}
							</div>
						}
						<div class="flex items-center gap-3 px-4 py-3">
							<div class="relative">
								<div class="w-8 h-8 rounded-lg bg-violet-500/10 border border-violet-500/20 flex items-center justify-center">
									<i class="fas fa-robot text-sm text-violet-400 pulse-glow"></i>
								</div>
								<div class="absolute inset-0 animate-spin" style="animation-duration: 3s;">
									<div class="absolute -top-0.5 left-1/2 -translate-x-1/2 w-1 h-1 bg-violet-400 rounded-full"></div>
								</div>
							</div>
							<div class="flex-1">
								<p class="text-sm font-medium shimmer">Agent is thinking...</p>
								<p class="text-[10px] text-gray-600">Analyzing code</p>
							</div>
							<button
								hx-post={ fmt.Sprintf("/action/abort/%s", task.ID) }
								hx-swap="none"
								class="w-6 h-6 rounded bg-red-500/20 border border-red-500/30 flex items-center justify-center text-red-400 hover:bg-red-500/30 hover:text-red-300 transition-colors"
								title="Stop agent"
							>
								<i class="fas fa-stop text-[10px]"></i>
							</button>
						</div>
					} else if len(task.Messages) > 0 {
						<div class="space-y-0">
							for _, msg := range task.Messages {
								@MessageBubble(msg)
							}
						</div>
					} else if task.AgentOutput != "" {
						<div class="p-5">
							<div class="text-sm text-gray-300 leading-normal prose prose-invert prose-sm prose-p:my-3 prose-headings:font-bold prose-headings:text-sm prose-headings:mt-4 prose-headings:mb-2 prose-code:text-xs prose-pre:text-xs prose-pre:my-3 prose-ul:my-2 prose-ol:my-2 prose-li:my-1 max-w-none">
								@templ.Raw(utils.RenderMarkdownHTML(task.AgentOutput))
							</div>
						</div>
					} else {
						<div class="p-5 text-gray-500 italic text-sm">No agent output</div>
					}
				</div>
			</div>
			<!-- Tab 2: DIFF -->
			<div x-show="activeTab === 'diff'" class="p-0 min-h-full pb-32">
				<div class="px-4 py-3 border-b border-gray-800 sticky top-0 bg-[#0D1117] z-10 flex justify-between">
					<span class="text-sm text-gray-400 font-mono">changes</span>
					<span class="text-[10px] text-green-500 font-mono">git diff</span>
				</div>
				<div id="diff-content" class="p-3 diff-container">
					if task.Status == "in_progress" {
						<div class="flex flex-col items-center justify-center h-48 text-gray-500 space-y-4">
							<i class="fas fa-cog fa-spin text-3xl opacity-50"></i>
							<p class="text-sm font-mono">Generating changes...</p>
						</div>
					} else if task.GitDiff != "" {
						@DiffView(task.GitDiff)
					} else {
						<div class="text-gray-500 italic">No changes made</div>
					}
				</div>
			</div>
			<!-- Tab 3: ACTIVITY -->
			<div x-show="activeTab === 'activity'" class="p-5 pb-32 space-y-6">
				<div id="log-content" class="relative border-l border-gray-800 ml-2 space-y-6">
					if len(task.Logs) == 0 {
						<div class="ml-4 text-sm text-gray-500 italic" id="no-activity-msg">No activity yet</div>
					}
					for _, log := range task.Logs {
						@LogEntry(log)
					}
				</div>
			</div>
		</div>
		<!-- Chat Input Overlay (separate from toolbar to prevent layout shift) -->
		<div x-show="showChat" x-transition.opacity.duration.150ms x-cloak class="absolute bottom-0 inset-x-0 z-20 pb-6 px-3"
			x-data="{ get app() { return Alpine.$data(document.body); } }">
			<!-- Subtle gradient fade -->
			<div class="absolute inset-0 bg-gradient-to-t from-[#0D1117] via-[#0D1117]/95 to-transparent pointer-events-none"></div>
			<form
				x-ref="chatForm"
				@submit.prevent="submitChat()"
				class="relative mx-auto max-w-xl bg-[#1C1F26] border border-gray-700/50 rounded-3xl shadow-2xl backdrop-blur-md transition-all duration-200 ring-1 ring-white/5 flex flex-col group focus-within:border-gray-600 focus-within:ring-white/10"
				x-init="$nextTick(() => $refs.chatInput.focus())"
			>
				<!-- Voice Recording Visualization -->
				<div x-show="app && app.isRecording" x-cloak
					class="absolute inset-0 bg-[#1C1F26] rounded-3xl flex items-center px-4 z-10">
					<!-- Cancel Button -->
					<button type="button" @click="app.cancelRecording()"
						class="w-8 h-8 rounded-full bg-gray-800 hover:bg-gray-700 flex items-center justify-center text-gray-400 hover:text-white transition shrink-0">
						<i class="fas fa-times text-sm"></i>
					</button>
					<!-- Waveform Bars -->
					<div class="flex-1 flex items-center justify-center gap-[3px] h-10 mx-4">
						<template x-for="(level, i) in (app ? app.audioLevels : [])" :key="i">
							<div class="w-1 bg-red-500 rounded-full transition-all duration-75"
								:style="`height: ${Math.max(4, level * 0.4)}px; opacity: ${0.4 + (level / 100) * 0.6}`"></div>
						</template>
					</div>
					<!-- Duration -->
					<div class="flex items-center gap-2 shrink-0">
						<div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
						<span class="text-sm text-gray-300 font-mono" x-text="app ? app.formatDuration(app.recordedDuration) : '0:00'"></span>
					</div>
				</div>

				<!-- Transcribing Overlay -->
				<div x-show="app && app.isTranscribing" x-cloak
					class="absolute inset-0 bg-[#1C1F26] rounded-3xl flex items-center justify-center z-10">
					<i class="fas fa-spinner fa-spin text-blue-400 mr-2"></i>
					<span class="text-gray-400 text-sm">Transcribing...</span>
				</div>

				<!-- Input Area -->
				<div class="relative px-4 pt-4 pb-2">
					<!-- File Menu Popover -->
					<div
						x-show="showFileMenu"
						x-cloak
						x-transition.opacity.duration.100ms
						class="absolute bottom-full left-0 mb-2 w-48 bg-[#16191F] border border-gray-700 rounded-xl shadow-2xl overflow-hidden max-h-40 overflow-y-auto z-50"
					>
						<div class="px-3 py-2 text-[10px] text-gray-500 font-bold uppercase tracking-wider border-b border-gray-800">Files</div>
						<template x-for="file in chatFiles">
							<div @click="insertFile(file)" class="px-3 py-2 hover:bg-white/10 text-xs text-gray-300 font-mono cursor-pointer transition">
								<span class="text-purple-400 opacity-60 mr-1">#</span><span x-text="file"></span>
							</div>
						</template>
					</div>

					<textarea
						name="message"
						x-model="chatText"
						x-ref="chatInput"
						@input="resizeChatInput()"
						@keyup="checkMention($event)"
						@keydown.enter="if (!$event.shiftKey) { $event.preventDefault(); submitChat(); }"
						rows="1"
						placeholder="Continue the conversation..."
						class="bg-transparent border-none focus:ring-0 focus:outline-none text-white text-base placeholder-gray-500 w-full resize-none font-medium p-0 leading-6 max-h-[40vh] min-h-[24px]"
					></textarea>
				</div>

				<!-- Toolbar -->
				<div class="flex items-center justify-between px-2 pb-2 mt-1">
					<!-- Left: Close + Attachment + Model -->
					<div class="flex items-center gap-1">
						<!-- Close -->
						<button type="button" @click="$dispatch('close-chat')"
							class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-200">
							<i class="fas fa-xmark text-sm"></i>
						</button>
						<!-- Attachment -->
						<button type="button"
							class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-200">
							<i class="fas fa-paperclip text-sm"></i>
						</button>
						<!-- Model Selector -->
						<div class="relative">
							<button type="button" @click="modelOpen = !modelOpen"
								class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-200">
								<i class="fas fa-bolt text-sm"></i>
							</button>
							<!-- Model Popover -->
							<div x-show="modelOpen" @click.outside="modelOpen = false" x-cloak
								x-transition.scale.origin.bottom.left
								class="absolute bottom-full left-0 mb-3 w-56 bg-[#16191F] border border-gray-700 rounded-xl shadow-xl overflow-hidden py-1 z-50">
								<div class="px-3 py-2 text-[10px] text-gray-500 font-bold uppercase tracking-wider bg-gray-900/50 border-b border-gray-800 mb-1">Select Model</div>
								<div class="p-1 space-y-0.5">
									<template x-for="m in models" :key="m.id">
										<div @click="setModel(m.id); modelOpen = false"
											:class="activeModelId === m.id ? 'bg-blue-500/10 text-blue-400 border-blue-500/20' : 'hover:bg-white/5 text-gray-400 hover:text-white border-transparent'"
											class="flex items-center justify-between px-3 py-2 rounded-lg cursor-pointer transition border">
											<span class="text-xs font-medium" x-text="m.name"></span>
											<div x-show="activeModelId === m.id"
												class="w-1.5 h-1.5 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.8)]"></div>
										</div>
									</template>
								</div>
							</div>
						</div>
					</div>

					<!-- Right: Queue indicator + Submit/Mic -->
					<div class="flex items-center gap-2">
						<!-- Queue indicator -->
						<template x-if="messageQueue.length > 0">
							<span class="text-[10px] text-purple-400 flex items-center gap-1">
								<i class="fas fa-clock"></i>
								<span x-text="messageQueue.length"></span> queued
							</span>
						</template>

						<!-- Divider -->
						<div class="w-px h-4 bg-gray-700"></div>

						<!-- Submit/Voice Button -->
						<button type="button"
							@click="if(chatText.length > 0) { navigator.vibrate && navigator.vibrate(30); submitChat(); }"
							@mousedown="if (chatText.length === 0 && app && !app.isRecording) app.startVoiceRecording($refs.chatInput)"
							@mouseup="if (app && app.isRecording) app.stopVoiceRecording()"
							@mouseleave="if (app && app.isRecording) app.stopVoiceRecording()"
							@touchstart.prevent="if (chatText.length === 0 && app && !app.isRecording) { navigator.vibrate && navigator.vibrate(50); app.startVoiceRecording($refs.chatInput); }"
							@touchend.prevent="if (app && app.isRecording) { navigator.vibrate && navigator.vibrate([30, 50, 30]); app.stopVoiceRecording(); } else if (chatText.length > 0) { navigator.vibrate && navigator.vibrate(30); submitChat(); }"
							@touchcancel="if (app && app.isRecording) app.cancelRecording()"
							:class="(app && app.isRecording) ? 'bg-red-500 shadow-[0_0_15px_rgba(239,68,68,0.4)] scale-110' : (chatText.length > 0 ? 'bg-blue-500 text-white shadow-[0_0_15px_rgba(59,130,246,0.4)]' : 'bg-gray-700 text-gray-300 hover:bg-gray-600')"
							class="w-8 h-8 rounded-lg flex items-center justify-center text-sm transition-all duration-200 select-none"
							:disabled="sendingMessage">
							<i class="fas"
								:class="sendingMessage ? 'fa-spinner fa-spin' : (chatText.length > 0 ? 'fa-arrow-up' : ((app && app.isRecording) ? 'fa-microphone animate-pulse' : 'fa-microphone'))"></i>
						</button>
					</div>
				</div>
			</form>
		</div>
		<!-- Bottom Actions Toolbar (Sticky) -->
		<div class="shrink-0 px-4 py-3 border-t border-white/[0.06] bg-[#16191F]/95 backdrop-blur-sm pb-6">
			<!-- Confirmation Modal (teleported to body to escape overflow:hidden) -->
			<template x-teleport="body">
				<div
					x-show="confirmAction"
					x-cloak
					x-transition:enter="transition ease-out duration-150"
					x-transition:enter-start="opacity-0"
					x-transition:enter-end="opacity-100"
					x-transition:leave="transition ease-in duration-100"
					x-transition:leave-start="opacity-100"
					x-transition:leave-end="opacity-0"
					class="fixed inset-0 z-[200] flex items-start justify-center pt-[25vh] bg-black/60 backdrop-blur-sm"
					@click.self="confirmAction = null"
					@keydown.escape.window="confirmAction = null"
				>
				<div
					x-show="confirmAction"
					x-transition:enter="transition ease-out duration-150"
					x-transition:enter-start="opacity-0 scale-95"
					x-transition:enter-end="opacity-100 scale-100"
					x-transition:leave="transition ease-in duration-100"
					x-transition:leave-start="opacity-100 scale-100"
					x-transition:leave-end="opacity-0 scale-95"
					class="bg-[#161b22] border border-gray-700/50 rounded-xl p-5 w-[320px] shadow-2xl"
				>
					<!-- Retry Confirmation -->
					<template x-if="confirmAction === 'retry'">
						<div class="space-y-4" x-init="htmx.process($el)">
							<div class="flex items-center gap-3">
								<div class="w-10 h-10 rounded-full bg-amber-500/10 flex items-center justify-center">
									<i class="fas fa-arrow-rotate-left text-amber-500"></i>
								</div>
								<div>
									<h3 class="font-semibold text-white">Retry Task</h3>
									<p class="text-xs text-gray-400">Re-run with the same prompt</p>
								</div>
							</div>
							<p class="text-sm text-gray-300">This will retry the previous prompt and overwrite any existing changes.</p>
							<div class="flex gap-2 pt-2">
								<button @click="confirmAction = null" class="flex-1 h-9 rounded-lg bg-gray-700/50 hover:bg-gray-700 text-gray-300 text-sm font-medium transition-colors">Cancel</button>
								<button
									hx-post={ fmt.Sprintf("/action/retry/%s", task.ID) }
									hx-swap="none"
									hx-disabled-elt="this"
									class="flex-1 h-9 rounded-lg bg-amber-600 hover:bg-amber-500 text-white text-sm font-medium transition-colors"
								><span class="htmx-request:hidden">Retry</span><i class="fas fa-spinner fa-spin hidden htmx-request:inline"></i></button>
							</div>
						</div>
					</template>
					<!-- Clear Confirmation -->
					<template x-if="confirmAction === 'clear'">
						<div class="space-y-4" x-init="htmx.process($el)">
							<div class="flex items-center gap-3">
								<div class="w-10 h-10 rounded-full bg-red-500/10 flex items-center justify-center">
									<i class="fas fa-eraser text-red-500"></i>
								</div>
								<div>
									<h3 class="font-semibold text-white">Clear History</h3>
									<p class="text-xs text-gray-400">Reset memory and context</p>
								</div>
							</div>
							<p class="text-sm text-gray-300">This will clear the chat history and agent output. The task will start fresh without any prior context.</p>
							<div class="flex gap-2 pt-2">
								<button @click="confirmAction = null" class="flex-1 h-9 rounded-lg bg-gray-700/50 hover:bg-gray-700 text-gray-300 text-sm font-medium transition-colors">Cancel</button>
								<button
									hx-post={ fmt.Sprintf("/action/clear/%s", task.ID) }
									hx-swap="none"
									hx-disabled-elt="this"
									class="flex-1 h-9 rounded-lg bg-red-600 hover:bg-red-500 text-white text-sm font-medium transition-colors"
								><span class="htmx-request:hidden">Clear</span><i class="fas fa-spinner fa-spin hidden htmx-request:inline"></i></button>
							</div>
						</div>
					</template>
					<!-- PR Confirmation -->
					<template x-if="confirmAction === 'pr'">
						<div class="space-y-4" x-init="htmx.process($el)">
							<div class="flex items-center gap-3">
								<div class="w-10 h-10 rounded-full bg-purple-500/10 flex items-center justify-center">
									<i class="fab fa-github text-purple-500"></i>
								</div>
								<div>
									<h3 class="font-semibold text-white">Create Pull Request</h3>
									<p class="text-xs text-gray-400">Push changes to GitHub</p>
								</div>
							</div>
							<p class="text-sm text-gray-300">This will create a new pull request on GitHub with all the changes from this task.</p>
							<div class="flex gap-2 pt-2">
								<button @click="confirmAction = null" class="flex-1 h-9 rounded-lg bg-gray-700/50 hover:bg-gray-700 text-gray-300 text-sm font-medium transition-colors">Cancel</button>
								<button
									hx-post={ fmt.Sprintf("/action/pr/%s", task.ID) }
									hx-swap="none"
									hx-disabled-elt="this"
									class="flex-1 h-9 rounded-lg bg-purple-600 hover:bg-purple-500 text-white text-sm font-medium transition-colors"
								><span class="htmx-request:hidden">Create PR</span><i class="fas fa-spinner fa-spin hidden htmx-request:inline"></i></button>
							</div>
						</div>
					</template>
					<!-- Merge Confirmation -->
					<template x-if="confirmAction === 'merge'">
						<div class="space-y-4" x-init="htmx.process($el)">
							<div class="flex items-center gap-3">
								<div class="w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center">
									<i class="fas fa-code-merge text-green-500"></i>
								</div>
								<div>
									<h3 class="font-semibold text-white">Merge to Main</h3>
									<p class="text-xs text-gray-400">Apply changes directly</p>
								</div>
							</div>
							<p class="text-sm text-gray-300">This will merge all changes directly into the main branch without creating a pull request.</p>
							<div class="flex gap-2 pt-2">
								<button @click="confirmAction = null" class="flex-1 h-9 rounded-lg bg-gray-700/50 hover:bg-gray-700 text-gray-300 text-sm font-medium transition-colors">Cancel</button>
								<button
									hx-post={ fmt.Sprintf("/action/merge/%s", task.ID) }
									hx-swap="none"
									hx-disabled-elt="this"
									class="flex-1 h-9 rounded-lg bg-green-600 hover:bg-green-500 text-white text-sm font-medium transition-colors"
								><span class="htmx-request:hidden">Merge</span><i class="fas fa-spinner fa-spin hidden htmx-request:inline"></i></button>
							</div>
						</div>
					</template>
				</div>
				</div>
			</template>
			<!-- Default Buttons (always in layout to prevent shift) -->
			<div :class="showChat ? 'invisible pointer-events-none' : ''" class="space-y-3">
				<!-- Secondary actions row -->
				<div class="flex justify-center gap-1">
					<button
						@click="confirmAction = 'retry'"
						class="px-3 py-1.5 rounded-full flex items-center gap-1.5 text-[11px] text-gray-500 hover:text-gray-300 hover:bg-white/[0.04] transition-all"
						title="Retry"
					>
						<i class="fas fa-arrow-rotate-left text-[10px]"></i>
						<span>Retry</span>
					</button>
					<span class="text-gray-700 self-center">·</span>
					<button
						@click="confirmAction = 'clear'"
						class="px-3 py-1.5 rounded-full flex items-center gap-1.5 text-[11px] text-gray-500 hover:text-gray-300 hover:bg-white/[0.04] transition-all"
						title="Clear history"
					>
						<i class="fas fa-eraser text-[10px]"></i>
						<span>Clear</span>
					</button>
					<span class="text-gray-700 self-center">·</span>
					<button
						@click="confirmAction = 'pr'"
						class="px-3 py-1.5 rounded-full flex items-center gap-1.5 text-[11px] text-gray-500 hover:text-gray-300 hover:bg-white/[0.04] transition-all"
						title="Create PR"
					>
						<i class="fab fa-github text-[10px]"></i>
						<span>Create PR</span>
					</button>
				</div>
				<!-- Main action buttons -->
				<div class="flex gap-2.5">
					<!-- Chat button -->
					<button
						@click="showChat = true"
						class="flex-1 h-9 bg-[#21262d] hover:bg-[#2d333b] border border-white/[0.08] hover:border-purple-500/30 text-white rounded-xl flex items-center justify-center gap-2 transition-all active:scale-[0.98] relative group"
					>
						<i class="fas fa-message text-xs text-purple-400 group-hover:text-purple-300 transition-colors"></i>
						<span class="text-xs font-medium">Chat</span>
						<!-- Queue badge -->
						<span 
							x-show="messageQueue.length > 0" 
							x-text="messageQueue.length"
							x-transition
							class="absolute -top-1 -right-1 w-4 h-4 bg-purple-500 text-white text-[9px] font-bold rounded-full flex items-center justify-center shadow-lg shadow-purple-500/30"
						></span>
					</button>
					<!-- Merge button -->
					<button
						@click="confirmAction = 'merge'"
						class="flex-1 h-9 bg-white hover:bg-gray-100 text-black rounded-xl flex items-center justify-center gap-2 transition-all active:scale-[0.98] shadow-lg shadow-white/10"
					>
						<i class="fas fa-code-merge text-xs"></i>
						<span class="text-xs font-medium">Merge</span>
					</button>
				</div>
			</div>
		</div>
	</div>
}

// DiffFile represents a single file in a diff
type DiffFile struct {
	Name  string
	Lines []DiffLine
}

// DiffLine represents a single line in a diff
type DiffLine struct {
	Type    string // "add", "del", "context", "hunk"
	Content string
	LineNum string
}

// ParseDiff parses a git diff into structured files
func ParseDiff(diff string) []DiffFile {
	var files []DiffFile
	var currentFile *DiffFile
	lineNum := 0

	for _, line := range strings.Split(diff, "\n") {
		if strings.HasPrefix(line, "diff --git") {
			// Start new file
			if currentFile != nil {
				files = append(files, *currentFile)
			}
			parts := strings.Split(line, " b/")
			name := ""
			if len(parts) > 1 {
				name = parts[len(parts)-1]
			}
			currentFile = &DiffFile{Name: name}
			lineNum = 0
		} else if currentFile == nil {
			continue
		} else if strings.HasPrefix(line, "@@") {
			currentFile.Lines = append(currentFile.Lines, DiffLine{Type: "hunk", Content: line})
		} else if strings.HasPrefix(line, "---") || strings.HasPrefix(line, "+++") || strings.HasPrefix(line, "index ") {
			// Skip meta
		} else if strings.HasPrefix(line, "+") {
			lineNum++
			currentFile.Lines = append(currentFile.Lines, DiffLine{Type: "add", Content: line, LineNum: fmt.Sprintf("%d", lineNum)})
		} else if strings.HasPrefix(line, "-") {
			currentFile.Lines = append(currentFile.Lines, DiffLine{Type: "del", Content: line})
		} else if line != "" {
			lineNum++
			currentFile.Lines = append(currentFile.Lines, DiffLine{Type: "context", Content: line, LineNum: fmt.Sprintf("%d", lineNum)})
		}
	}
	if currentFile != nil {
		files = append(files, *currentFile)
	}
	return files
}

// DiffView renders a GitHub-style diff view
templ DiffView(diff string) {
	for _, file := range ParseDiff(diff) {
		<div class="diff-file-header">
			<i class="fas fa-file-code mr-2 text-gray-500"></i>
			{ file.Name }
		</div>
		<div class="diff-file-body">
			for _, line := range file.Lines {
				if line.Type == "hunk" {
					<div class="diff-hunk">{ line.Content }</div>
				} else if line.Type == "add" {
					<div class="diff-line diff-add">
						<span class="diff-line-num">{ line.LineNum }</span>
						<span class="diff-line-content">{ line.Content }</span>
					</div>
				} else if line.Type == "del" {
					<div class="diff-line diff-del">
						<span class="diff-line-num"></span>
						<span class="diff-line-content">{ line.Content }</span>
					</div>
				} else {
					<div class="diff-line diff-context">
						<span class="diff-line-num">{ line.LineNum }</span>
						<span class="diff-line-content">{ line.Content }</span>
					</div>
				}
			}
		</div>
	}
}
