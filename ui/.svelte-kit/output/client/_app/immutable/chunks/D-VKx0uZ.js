var E=e=>{throw TypeError(e)};var z=(e,t,s)=>t.has(e)||E("Cannot "+s);var a=(e,t,s)=>(z(e,t,"read from private field"),s?s.call(e):t.get(e)),i=(e,t,s)=>t.has(e)?E("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s);import{X as o,o as n,m as r,ay as L}from"./BipdXalV.js";const R=[{id:"o#anthropic/claude-sonnet-4.5",name:"Claude Sonnet 4.5"},{id:"o#anthropic/claude-opus-4.5",name:"Claude Opus 4.5"},{id:"o#google/gemini-3-pro-preview",name:"Gemini 3 Pro Preview"},{id:"o#google/gemini-3-flash-preview",name:"Gemini 3 Flash Preview"},{id:"o#openai/gpt-5.2",name:"GPT 5.2"},{id:"o#openai/gpt-5.1-codex-max",name:"GPT 5.1 Codex Max"},{id:"zai#glm-4.7",name:"GLM 4.7"}],N="";async function h(e,t={}){const s=await fetch(`${N}${e}`,{...t,headers:{"Content-Type":"application/json",...t.headers},credentials:"include"});if(!s.ok){const c=await s.text().catch(()=>"Unknown error");throw new Error(`API error: ${s.status} - ${c}`)}return s.json()}async function u(e,t){const s=await fetch(`${N}${e}`,{method:"POST",body:t,credentials:"include"});if(!s.ok){const c=await s.text().catch(()=>"Unknown error");throw new Error(`API error: ${s.status} - ${c}`)}}const d={async checkSession(){try{return await h("/api/session")}catch{return{authenticated:!1,githubConnected:!1,needsGitHubAuth:!1}}},async loginWithGitHub(){window.location.href="/auth/oauth/github"},async connectGitHub(){window.location.href="/api/github/authorize"},async logout(){try{await h("/api/logout",{method:"POST"})}catch(e){console.error("Logout error (ignoring):",e)}window.location.href="/"},async disconnect(){try{await h("/api/disconnect",{method:"POST"})}catch(e){throw console.error("Disconnect error:",e),e}window.location.href="/"}},x={async list(){const e=await h("/api/feed");return Object.values(e.projects||{})},async getMap(){return(await h("/api/feed")).projects||{}},async activate(e,t){const s=new FormData;s.append("owner",e),s.append("repo",t),await u("/api/project/activate",s)}},U={async listRepos(){return h("/api/github/repos")}},Q={async getFeed(){return h("/api/feed")},async get(e){return h(`/api/task/${e}`)},async create(e,t,s){const c=new FormData;c.append("voice_input",e),c.append("project_id",t),c.append("model_id",s),await u("/api/add-task",c)},async chat(e,t,s){const c=new FormData;c.append("message",t),s&&c.append("model_id",s),await u(`/api/action/chat/${e}`,c)},async retry(e){await h(`/api/action/retry/${e}`,{method:"POST"})},async clear(e){await h(`/api/action/clear/${e}`,{method:"POST"})},async merge(e){await h(`/api/action/merge/${e}`,{method:"POST"})},async createPR(e){await h(`/api/action/pr/${e}`,{method:"POST"})},async discard(e){await h(`/api/action/discard/${e}`,{method:"POST"})},async resolveConflict(e,t,s){const c=new FormData;c.append("file",t),c.append("choice",s),await u(`/api/action/resolve-conflict/${e}`,c)},async abortMerge(e){await h(`/api/action/abort-merge/${e}`,{method:"POST"})},async completeMerge(e){await h(`/api/action/complete-merge/${e}`,{method:"POST"})}},K={async get(){return h("/api/settings")},async save(e){const t=new FormData;t.append("agent_backend",e.agentBackend),e.openRouterKey&&t.append("openrouter_key",e.openRouterKey),e.zaiKey&&t.append("zai_key",e.zaiKey),e.anthropicKey&&t.append("anthropic_key",e.anthropicKey),e.openAiKey&&t.append("openai_key",e.openAiKey),await u("/api/settings",t)}},V={async search(e,t){if(!t||t.length<2)return[];const s=new URLSearchParams({project_id:e,q:t});return h(`/api/files/search?${s}`)}};var p,g,m,f,w,y,P,j,v,b,I,O,A,S,_,M,T,k,$,D,G,F,C,H;class B{constructor(){i(this,p,o(!1));i(this,g,o(null));i(this,m,o(!1));i(this,f,o(!1));i(this,w,o(!1));i(this,y,o(!1));i(this,P,o(""));i(this,j,o(""));i(this,v,o(""));i(this,b,o(L([])));i(this,I,o(L([])));i(this,O,o(""));i(this,A,o(!1));i(this,S,o(!1));i(this,_,o(L(Array(12).fill(0))));i(this,M,o(0));i(this,T,o(null));i(this,k,o(!1));i(this,$,o(!1));i(this,D,o(""));i(this,G,o(!1));i(this,F,o(""));i(this,C,o(!1));i(this,H,o(null));typeof window<"u"&&(this.activeProjectId=localStorage.getItem("counterspell_active_project_id")||"",this.activeProjectName=localStorage.getItem("counterspell_active_project_name")||"",this.activeModelId=localStorage.getItem("counterspell_model")||R[0].id)}get modalOpen(){return n(a(this,p))}set modalOpen(t){r(a(this,p),t,!0)}get modalTaskId(){return n(a(this,g))}set modalTaskId(t){r(a(this,g),t,!0)}get settingsOpen(){return n(a(this,m))}set settingsOpen(t){r(a(this,m),t,!0)}get projectMenuOpen(){return n(a(this,f))}set projectMenuOpen(t){r(a(this,f),t,!0)}get inputProjectMenuOpen(){return n(a(this,w))}set inputProjectMenuOpen(t){r(a(this,w),t,!0)}get toastOpen(){return n(a(this,y))}set toastOpen(t){r(a(this,y),t,!0)}get toastMsg(){return n(a(this,P))}set toastMsg(t){r(a(this,P),t,!0)}get activeProjectId(){return n(a(this,j))}set activeProjectId(t){r(a(this,j),t,!0)}get activeProjectName(){return n(a(this,v))}set activeProjectName(t){r(a(this,v),t,!0)}get projects(){return n(a(this,b))}set projects(t){r(a(this,b),t,!0)}get repos(){return n(a(this,I))}set repos(t){r(a(this,I),t,!0)}get activeModelId(){return n(a(this,O))}set activeModelId(t){r(a(this,O),t,!0)}get isRecording(){return n(a(this,A))}set isRecording(t){r(a(this,A),t,!0)}get isTranscribing(){return n(a(this,S))}set isTranscribing(t){r(a(this,S),t,!0)}get audioLevels(){return n(a(this,_))}set audioLevels(t){r(a(this,_),t,!0)}get recordedDuration(){return n(a(this,M))}set recordedDuration(t){r(a(this,M),t,!0)}get deferredPrompt(){return n(a(this,T))}set deferredPrompt(t){r(a(this,T),t,!0)}get canInstallPWA(){return n(a(this,k))}set canInstallPWA(t){r(a(this,k),t,!0)}get isAuthenticated(){return n(a(this,$))}set isAuthenticated(t){r(a(this,$),t,!0)}get userEmail(){return n(a(this,D))}set userEmail(t){r(a(this,D),t,!0)}get githubConnected(){return n(a(this,G))}set githubConnected(t){r(a(this,G),t,!0)}get githubLogin(){return n(a(this,F))}set githubLogin(t){r(a(this,F),t,!0)}get needsGitHubAuth(){return n(a(this,C))}set needsGitHubAuth(t){r(a(this,C),t,!0)}get settings(){return n(a(this,H))}set settings(t){r(a(this,H),t,!0)}async init(){await this.checkAuth(),await this.loadProjects(),await this.loadRepos(),await this.loadSettings()}async checkAuth(){try{const t=await d.checkSession();this.isAuthenticated=t.authenticated,this.userEmail=t.email||"",this.githubConnected=t.githubConnected,this.githubLogin=t.githubLogin||"",this.needsGitHubAuth=t.needsGitHubAuth}catch(t){console.error("Auth check failed:",t),this.isAuthenticated=!1,this.githubConnected=!1,this.needsGitHubAuth=!1}}async loadProjects(){try{this.projects=await x.list()}catch(t){console.error("Failed to load projects:",t)}}async loadRepos(){try{this.repos=await U.listRepos()}catch(t){console.error("Failed to load repos:",t)}}async loadSettings(){try{this.settings=await K.get()}catch(t){console.error("Failed to load settings:",t)}}get modelName(){const t=R.find(s=>s.id===this.activeModelId);return t?t.name.split(" ")[1]:this.activeModelId.split("#")[1]}async setActiveProject(t,s){if(t.match(/^\d+$/)){const c=this.repos.find(l=>l.id.toString()===t);if(c)try{await x.activate(c.owner,c.name),await this.loadProjects();const l=this.projects.find(W=>W.name===c.full_name);l&&(t=l.id,s=l.name)}catch(l){console.error("Failed to activate project:",l),this.showToast("Failed to activate project");return}}this.activeProjectId=t,this.activeProjectName=s,localStorage.setItem("counterspell_active_project_id",t),localStorage.setItem("counterspell_active_project_name",s),this.inputProjectMenuOpen=!1,this.projectMenuOpen=!1}setModel(t){this.activeModelId=t,localStorage.setItem("counterspell_model",t)}showToast(t){this.toastMsg=t,this.toastOpen=!0,setTimeout(()=>{this.toastOpen=!1},3e3)}closeModal(){var t;this.modalOpen&&(this.modalOpen=!1,this.modalTaskId=null,(t=history.state)!=null&&t.modal&&history.back())}openModal(t){this.modalTaskId=t,this.modalOpen=!0,history.pushState({modal:!0},"")}installPWA(){this.deferredPrompt&&(this.deferredPrompt.prompt(),this.deferredPrompt.userChoice.then(t=>{t.outcome==="accepted"&&this.showToast("Installing app..."),this.deferredPrompt=null,this.canInstallPWA=!1}))}clearState(){this.modalOpen=!1,this.modalTaskId=null,this.settingsOpen=!1,this.projectMenuOpen=!1,this.inputProjectMenuOpen=!1,this.activeProjectId="",this.activeProjectName="",this.projects=[],this.repos=[],this.isAuthenticated=!1,this.userEmail="",this.githubConnected=!1,this.githubLogin="",this.needsGitHubAuth=!1,this.settings=null,typeof window<"u"&&(localStorage.removeItem("counterspell_active_project_id"),localStorage.removeItem("counterspell_active_project_name"),localStorage.removeItem("counterspell_model"),sessionStorage.clear())}async login(){await d.loginWithGitHub()}async connectGitHub(){await d.connectGitHub()}async logout(){this.clearState(),await d.logout()}async disconnect(){if(confirm("Are you sure you want to disconnect GitHub and DELETE all project data? This cannot be undone.")){this.clearState();try{await d.disconnect()}catch(s){console.error("Failed to disconnect:",s),this.showToast("Failed to disconnect properly")}}}openSettings(){this.settingsOpen=!0}closeSettings(){this.settingsOpen=!1}async saveSettings(t){try{await K.save(t),this.settings=t,this.closeSettings(),this.showToast("Settings saved")}catch(s){console.error("Failed to save settings:",s),this.showToast("Failed to save settings")}}}p=new WeakMap,g=new WeakMap,m=new WeakMap,f=new WeakMap,w=new WeakMap,y=new WeakMap,P=new WeakMap,j=new WeakMap,v=new WeakMap,b=new WeakMap,I=new WeakMap,O=new WeakMap,A=new WeakMap,S=new WeakMap,_=new WeakMap,M=new WeakMap,T=new WeakMap,k=new WeakMap,$=new WeakMap,D=new WeakMap,G=new WeakMap,F=new WeakMap,C=new WeakMap,H=new WeakMap;const Y=new B;export{R as M,Y as a,d as b,V as f,Q as t};
