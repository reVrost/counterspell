version: "3.9"

services:
  db:
    image: postgres:16-alpine
    ports:
      - "${POSTGRES_PORT:-55432}:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-invoker}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-invoker}
      POSTGRES_DB: ${POSTGRES_DB:-invoker}
    volumes:
      - invoker_pgdata:/var/lib/postgresql/data

  invoker:
    build: .
    ports:
      - "${INVOKER_PORT:-18079}:8080"
    environment:
      PORT: 8080
      DATABASE_URL: postgres://${POSTGRES_USER:-invoker}:${POSTGRES_PASSWORD:-invoker}@db:5432/${POSTGRES_DB:-invoker}?sslmode=disable
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      JWT_SECRET: ${JWT_SECRET}
      DEVICE_VERIFICATION_URL: ${DEVICE_VERIFICATION_URL:-https://counterspell.io/device}
      CLOUDFLARE_ACCOUNT_ID: ${CLOUDFLARE_ACCOUNT_ID}
      CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN}
      CLOUDFLARE_ZONE_NAME: ${CLOUDFLARE_ZONE_NAME:-counterspell.app}
      CLOUDFLARE_ZONE_ID: ${CLOUDFLARE_ZONE_ID}
    depends_on:
      - db

volumes:
  invoker_pgdata:
