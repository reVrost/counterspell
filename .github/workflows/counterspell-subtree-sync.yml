name: Publish Counterspell (subtree)

on:
  push:
    branches: [main]
    paths:
      - "counterspell/**"
      - ".github/workflows/counterspell-subtree-sync.yml"

env:
  SUBTREE_PREFIX: counterspell
  PUBLIC_REPO: revrost/counterspell
  PUBLIC_BRANCH: main

jobs:
  subtree-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "cs-platform bot"
          git config user.email "actions@github.com"

      - name: Add public remote
        run: |
          git remote add public "https://x-access-token:${{ secrets.COUNTERSPELL_SUBTREE_PAT }}@github.com/${PUBLIC_REPO}.git"

      - name: Push subtree
        run: |
          git subtree push --prefix="${SUBTREE_PREFIX}" public "${PUBLIC_BRANCH}"
